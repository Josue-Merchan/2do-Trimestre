#include <WiFi.h>
#include <ThingerESP32.h>

#define USERNAME "josue_merchan"
#define DEVICE_ID "foco"
#define DEVICE_CREDENTIAL "20260026"

#define SSID "JOU2022"
#define PASSWORD  "merchan2022"

#define PIN_RELE 5
#define PIN_BOTON 4

ThingerESP32 thing(USERNAME, DEVICE_ID, DEVICE_CREDENTIAL);

bool estadoRele = false;

void setup() {
  Serial.begin(115200);

  pinMode(PIN_RELE, OUTPUT);
  pinMode(PIN_BOTON, INPUT_PULLUP);  // Pull-up interno activado

  digitalWrite(PIN_RELE, LOW);  // Relé apagado al inicio

  thing.add_wifi(SSID, PASSWORD);

  // Recurso en Thinger
  thing["RELE"] << [](pson &in){
    if(in.is_empty()){
      in = estadoRele;     // Enviar estado actual al dashboard
    } else {
      estadoRele = in;     // Recibir cambio desde dashboard
    }
  };
}

void loop() {

  thing.handle();

  // ----------- BOTÓN (TOGGLE SIMPLE) -----------
  static bool botonAnterior = HIGH;
  bool botonActual = digitalRead(PIN_BOTON);

  if (botonAnterior == HIGH && botonActual == LOW) {
    estadoRele = !estadoRele;   // Cambia estado
    delay(200);                 // Antirrebote simple
  }

  botonAnterior = botonActual;

  // ----------- ACTUALIZAR RELÉ -----------
  digitalWrite(PIN_RELE, !estadoRele);
}
